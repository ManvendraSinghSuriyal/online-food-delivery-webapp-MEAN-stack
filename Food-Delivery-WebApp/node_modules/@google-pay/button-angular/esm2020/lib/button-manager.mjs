/**
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
/* eslint-disable react/no-is-mounted */
import { loadScript } from '../lib/load-script';
/**
 * Manages the lifecycle of the Google Pay button.
 *
 * Includes lifecycle management of the `PaymentsClient` instance,
 * `isReadyToPay`, `onClick`, `loadPaymentData`, and other callback methods.
 */
export class ButtonManager {
    constructor(options) {
        /**
         * Handles the click event of the Google Pay button.
         *
         * This method would normally be private but has been made public for
         * testing purposes.
         *
         * @private
         */
        this.handleClick = async (event) => {
            const config = this.config;
            if (!config) {
                throw new Error('google-pay-button: Missing configuration');
            }
            const request = this.createLoadPaymentDataRequest(config);
            try {
                if (config.onClick) {
                    config.onClick(event);
                }
                if (event.defaultPrevented) {
                    return;
                }
                const result = await this.client.loadPaymentData(request);
                if (config.onLoadPaymentData) {
                    config.onLoadPaymentData(result);
                }
            }
            catch (err) {
                if (err.statusCode === 'CANCELED') {
                    if (config.onCancel) {
                        config.onCancel(err);
                    }
                }
                else if (config.onError) {
                    config.onError(err);
                }
                else {
                    console.error(err);
                }
            }
        };
        this.options = options;
    }
    getElement() {
        return this.element;
    }
    isGooglePayLoaded() {
        return 'google' in (window || global) && !!google?.payments?.api?.PaymentsClient;
    }
    async mount(element) {
        if (!this.isGooglePayLoaded()) {
            try {
                await loadScript('https://pay.google.com/gp/p/js/pay.js');
            }
            catch (err) {
                if (this.config?.onError) {
                    this.config.onError(err);
                }
                else {
                    console.error(err);
                }
                return;
            }
        }
        this.element = element;
        if (element) {
            this.appendStyles();
            if (this.config) {
                this.updateElement();
            }
        }
    }
    unmount() {
        this.element = undefined;
    }
    configure(newConfig) {
        let promise = undefined;
        this.config = newConfig;
        if (!this.oldInvalidationValues || this.isClientInvalidated(newConfig)) {
            promise = this.updateElement();
        }
        this.oldInvalidationValues = this.getInvalidationValues(newConfig);
        return promise ?? Promise.resolve();
    }
    /**
     * Creates client configuration options based on button configuration
     * options.
     *
     * This method would normally be private but has been made public for
     * testing purposes.
     *
     * @private
     */
    createClientOptions(config) {
        const clientConfig = {
            environment: config.environment,
            merchantInfo: this.createMerchantInfo(config),
        };
        if (config.onPaymentDataChanged || config.onPaymentAuthorized) {
            clientConfig.paymentDataCallbacks = {};
            if (config.onPaymentDataChanged) {
                // eslint-disable-next-line @typescript-eslint/explicit-function-return-type
                clientConfig.paymentDataCallbacks.onPaymentDataChanged = paymentData => {
                    const result = config.onPaymentDataChanged(paymentData);
                    return result || {};
                };
            }
            if (config.onPaymentAuthorized) {
                // eslint-disable-next-line @typescript-eslint/explicit-function-return-type
                clientConfig.paymentDataCallbacks.onPaymentAuthorized = paymentData => {
                    const result = config.onPaymentAuthorized(paymentData);
                    return result || {};
                };
            }
        }
        return clientConfig;
    }
    createIsReadyToPayRequest(config) {
        const paymentRequest = config.paymentRequest;
        const request = {
            apiVersion: paymentRequest.apiVersion,
            apiVersionMinor: paymentRequest.apiVersionMinor,
            allowedPaymentMethods: paymentRequest.allowedPaymentMethods,
            existingPaymentMethodRequired: config.existingPaymentMethodRequired,
        };
        return request;
    }
    /**
     * Constructs `loadPaymentData` request object based on button configuration.
     *
     * It infers request properties like `shippingAddressRequired`,
     * `shippingOptionRequired`, and `billingAddressRequired` if not already set
     * based on the presence of their associated options and parameters. It also
     * infers `callbackIntents` based on the callback methods defined in button
     * configuration.
     *
     * This method would normally be private but has been made public for
     * testing purposes.
     *
     * @private
     */
    createLoadPaymentDataRequest(config) {
        const request = {
            ...config.paymentRequest,
            merchantInfo: this.createMerchantInfo(config),
        };
        // TODO: #13 re-enable inferrence if/when we agree as a team
        return request;
    }
    createMerchantInfo(config) {
        const merchantInfo = {
            ...config.paymentRequest.merchantInfo,
        };
        // apply softwareInfo if not set
        if (!merchantInfo.softwareInfo) {
            merchantInfo.softwareInfo = {
                id: this.options.softwareInfoId,
                version: this.options.softwareInfoVersion,
            };
        }
        return merchantInfo;
    }
    isMounted() {
        return this.element != null && this.element.isConnected !== false;
    }
    removeButton() {
        if (this.element instanceof ShadowRoot || this.element instanceof Element) {
            for (const child of Array.from(this.element.children)) {
                if (child.tagName !== 'STYLE') {
                    child.remove();
                }
            }
        }
    }
    async updateElement() {
        if (!this.isMounted())
            return;
        const element = this.getElement();
        if (!this.config) {
            throw new Error('google-pay-button: Missing configuration');
        }
        // remove existing button
        this.removeButton();
        try {
            this.client = new google.payments.api.PaymentsClient(this.createClientOptions(this.config));
        }
        catch (err) {
            if (this.config.onError) {
                this.config.onError(err);
            }
            else {
                console.error(err);
            }
            return;
        }
        const buttonOptions = {
            buttonType: this.config.buttonType,
            buttonColor: this.config.buttonColor,
            buttonSizeMode: this.config.buttonSizeMode,
            buttonLocale: this.config.buttonLocale,
            onClick: this.handleClick,
            allowedPaymentMethods: this.config.paymentRequest.allowedPaymentMethods,
        };
        const rootNode = element.getRootNode();
        if (rootNode instanceof ShadowRoot) {
            buttonOptions.buttonRootNode = rootNode;
        }
        // pre-create button
        const button = this.client.createButton(buttonOptions);
        this.setClassName(element, [element.className, 'not-ready']);
        element.appendChild(button);
        let showButton = false;
        let readyToPay;
        try {
            readyToPay = await this.client.isReadyToPay(this.createIsReadyToPayRequest(this.config));
            showButton =
                (readyToPay.result && !this.config.existingPaymentMethodRequired)
                    || (readyToPay.result && readyToPay.paymentMethodPresent && this.config.existingPaymentMethodRequired)
                    || false;
        }
        catch (err) {
            if (this.config.onError) {
                this.config.onError(err);
            }
            else {
                console.error(err);
            }
        }
        if (!this.isMounted())
            return;
        if (showButton) {
            try {
                this.client.prefetchPaymentData(this.createLoadPaymentDataRequest(this.config));
            }
            catch (err) {
                console.log('Error with prefetch', err);
            }
            // remove hidden className
            this.setClassName(element, (element.className || '').split(' ').filter(className => className && className !== 'not-ready'));
        }
        if (this.isReadyToPay !== readyToPay?.result || this.paymentMethodPresent !== readyToPay?.paymentMethodPresent) {
            this.isReadyToPay = !!readyToPay?.result;
            this.paymentMethodPresent = readyToPay?.paymentMethodPresent;
            if (this.config.onReadyToPayChange) {
                const readyToPayResponse = {
                    isButtonVisible: showButton,
                    isReadyToPay: this.isReadyToPay,
                };
                if (this.paymentMethodPresent) {
                    readyToPayResponse.paymentMethodPresent = this.paymentMethodPresent;
                }
                this.config.onReadyToPayChange(readyToPayResponse);
            }
        }
    }
    setClassName(element, classNames) {
        const className = classNames.filter(name => name).join(' ');
        if (className) {
            element.className = className;
        }
        else {
            element.removeAttribute('class');
        }
    }
    appendStyles() {
        if (typeof document === 'undefined')
            return;
        const rootNode = this.element?.getRootNode();
        const styleId = `default-google-style-${this.options.cssSelector.replace(/[^\w-]+/g, '')}-${this.config?.buttonLocale}`;
        // initialize styles if rendering on the client:
        if (rootNode) {
            if (!rootNode.getElementById?.(styleId)) {
                const style = document.createElement('style');
                style.id = styleId;
                style.type = 'text/css';
                style.innerHTML = `
          ${this.options.cssSelector} {
            display: inline-block;
          }
          ${this.options.cssSelector}.not-ready {
            width: 0;
            height: 0;
            overflow: hidden;
          }
        `;
                if (rootNode instanceof Document && rootNode.head) {
                    rootNode.head.appendChild(style);
                }
                else {
                    rootNode.appendChild(style);
                }
            }
        }
    }
    isClientInvalidated(newConfig) {
        if (!this.oldInvalidationValues)
            return true;
        const newValues = this.getInvalidationValues(newConfig);
        return newValues.some((value, index) => JSON.stringify(value) !== JSON.stringify(this.oldInvalidationValues[index]));
    }
    getInvalidationValues(config) {
        return [
            config.environment,
            config.existingPaymentMethodRequired,
            !!config.onPaymentDataChanged,
            !!config.onPaymentAuthorized,
            config.buttonColor,
            config.buttonType,
            config.buttonLocale,
            config.buttonSizeMode,
            config.paymentRequest.merchantInfo.merchantId,
            config.paymentRequest.merchantInfo.merchantName,
            config.paymentRequest.merchantInfo.softwareInfo?.id,
            config.paymentRequest.merchantInfo.softwareInfo?.version,
            config.paymentRequest.allowedPaymentMethods,
        ];
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnV0dG9uLW1hbmFnZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9saWIvYnV0dG9uLW1hbmFnZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7O0dBY0c7QUFFSCx3Q0FBd0M7QUFFeEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBK0JoRDs7Ozs7R0FLRztBQUNILE1BQU0sT0FBTyxhQUFhO0lBVXhCLFlBQVksT0FBNkI7UUF5UHpDOzs7Ozs7O1dBT0c7UUFDSCxnQkFBVyxHQUFHLEtBQUssRUFBRSxLQUFZLEVBQWlCLEVBQUU7WUFDbEQsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQztZQUMzQixJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNYLE1BQU0sSUFBSSxLQUFLLENBQUMsMENBQTBDLENBQUMsQ0FBQzthQUM3RDtZQUVELE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxNQUFNLENBQUMsQ0FBQztZQUUxRCxJQUFJO2dCQUNGLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRTtvQkFDbEIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDdkI7Z0JBRUQsSUFBSSxLQUFLLENBQUMsZ0JBQWdCLEVBQUU7b0JBQzFCLE9BQU87aUJBQ1I7Z0JBRUQsTUFBTSxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsTUFBTyxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFFM0QsSUFBSSxNQUFNLENBQUMsaUJBQWlCLEVBQUU7b0JBQzVCLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztpQkFDbEM7YUFDRjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLElBQUssR0FBeUMsQ0FBQyxVQUFVLEtBQUssVUFBVSxFQUFFO29CQUN4RSxJQUFJLE1BQU0sQ0FBQyxRQUFRLEVBQUU7d0JBQ25CLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBd0MsQ0FBQyxDQUFDO3FCQUMzRDtpQkFDRjtxQkFBTSxJQUFJLE1BQU0sQ0FBQyxPQUFPLEVBQUU7b0JBQ3pCLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBd0MsQ0FBQyxDQUFDO2lCQUMxRDtxQkFBTTtvQkFDTCxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2lCQUNwQjthQUNGO1FBQ0gsQ0FBQyxDQUFDO1FBalNBLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQ3pCLENBQUM7SUFFRCxVQUFVO1FBQ1IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDO0lBQ3RCLENBQUM7SUFFTyxpQkFBaUI7UUFDdkIsT0FBTyxRQUFRLElBQUksQ0FBQyxNQUFNLElBQUksTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLGNBQWMsQ0FBQztJQUNuRixDQUFDO0lBRUQsS0FBSyxDQUFDLEtBQUssQ0FBQyxPQUFnQjtRQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFLEVBQUU7WUFDN0IsSUFBSTtnQkFDRixNQUFNLFVBQVUsQ0FBQyx1Q0FBdUMsQ0FBQyxDQUFDO2FBQzNEO1lBQUMsT0FBTyxHQUFHLEVBQUU7Z0JBQ1osSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLE9BQU8sRUFBRTtvQkFDeEIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBWSxDQUFDLENBQUM7aUJBQ25DO3FCQUFNO29CQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7aUJBQ3BCO2dCQUNELE9BQU87YUFDUjtTQUNGO1FBRUQsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7UUFDdkIsSUFBSSxPQUFPLEVBQUU7WUFDWCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7WUFDcEIsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFO2dCQUNmLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQzthQUN0QjtTQUNGO0lBQ0gsQ0FBQztJQUVELE9BQU87UUFDTCxJQUFJLENBQUMsT0FBTyxHQUFHLFNBQVMsQ0FBQztJQUMzQixDQUFDO0lBRUQsU0FBUyxDQUFDLFNBQWlCO1FBQ3pCLElBQUksT0FBTyxHQUE4QixTQUFTLENBQUM7UUFDbkQsSUFBSSxDQUFDLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDeEIsSUFBSSxDQUFDLElBQUksQ0FBQyxxQkFBcUIsSUFBSSxJQUFJLENBQUMsbUJBQW1CLENBQUMsU0FBUyxDQUFDLEVBQUU7WUFDdEUsT0FBTyxHQUFHLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztTQUNoQztRQUNELElBQUksQ0FBQyxxQkFBcUIsR0FBRyxJQUFJLENBQUMscUJBQXFCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFFbkUsT0FBTyxPQUFPLElBQUksT0FBTyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3RDLENBQUM7SUFFRDs7Ozs7Ozs7T0FRRztJQUNILG1CQUFtQixDQUFDLE1BQWM7UUFDaEMsTUFBTSxZQUFZLEdBQXVDO1lBQ3ZELFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVztZQUMvQixZQUFZLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztTQUM5QyxDQUFDO1FBRUYsSUFBSSxNQUFNLENBQUMsb0JBQW9CLElBQUksTUFBTSxDQUFDLG1CQUFtQixFQUFFO1lBQzdELFlBQVksQ0FBQyxvQkFBb0IsR0FBRyxFQUFFLENBQUM7WUFFdkMsSUFBSSxNQUFNLENBQUMsb0JBQW9CLEVBQUU7Z0JBQy9CLDRFQUE0RTtnQkFDNUUsWUFBWSxDQUFDLG9CQUFvQixDQUFDLG9CQUFvQixHQUFHLFdBQVcsQ0FBQyxFQUFFO29CQUNyRSxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsb0JBQXFCLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQ3pELE9BQU8sTUFBTSxJQUFLLEVBQW1ELENBQUM7Z0JBQ3hFLENBQUMsQ0FBQzthQUNIO1lBRUQsSUFBSSxNQUFNLENBQUMsbUJBQW1CLEVBQUU7Z0JBQzlCLDRFQUE0RTtnQkFDNUUsWUFBWSxDQUFDLG9CQUFvQixDQUFDLG1CQUFtQixHQUFHLFdBQVcsQ0FBQyxFQUFFO29CQUNwRSxNQUFNLE1BQU0sR0FBRyxNQUFNLENBQUMsbUJBQW9CLENBQUMsV0FBVyxDQUFDLENBQUM7b0JBQ3hELE9BQU8sTUFBTSxJQUFLLEVBQXFELENBQUM7Z0JBQzFFLENBQUMsQ0FBQzthQUNIO1NBQ0Y7UUFFRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRU8seUJBQXlCLENBQUMsTUFBYztRQUM5QyxNQUFNLGNBQWMsR0FBRyxNQUFNLENBQUMsY0FBYyxDQUFDO1FBQzdDLE1BQU0sT0FBTyxHQUE0QztZQUN2RCxVQUFVLEVBQUUsY0FBYyxDQUFDLFVBQVU7WUFDckMsZUFBZSxFQUFFLGNBQWMsQ0FBQyxlQUFlO1lBQy9DLHFCQUFxQixFQUFFLGNBQWMsQ0FBQyxxQkFBcUI7WUFDM0QsNkJBQTZCLEVBQUUsTUFBTSxDQUFDLDZCQUE2QjtTQUNwRSxDQUFDO1FBRUYsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7O09BYUc7SUFDSCw0QkFBNEIsQ0FBQyxNQUFjO1FBQ3pDLE1BQU0sT0FBTyxHQUFHO1lBQ2QsR0FBRyxNQUFNLENBQUMsY0FBYztZQUN4QixZQUFZLEVBQUUsSUFBSSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sQ0FBQztTQUM5QyxDQUFDO1FBRUYsNERBQTREO1FBRTVELE9BQU8sT0FBTyxDQUFDO0lBQ2pCLENBQUM7SUFFTyxrQkFBa0IsQ0FBQyxNQUFjO1FBQ3ZDLE1BQU0sWUFBWSxHQUFxQztZQUNyRCxHQUFHLE1BQU0sQ0FBQyxjQUFjLENBQUMsWUFBWTtTQUN0QyxDQUFDO1FBRUYsZ0NBQWdDO1FBQ2hDLElBQUksQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFO1lBQzlCLFlBQVksQ0FBQyxZQUFZLEdBQUc7Z0JBQzFCLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGNBQWM7Z0JBQy9CLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLG1CQUFtQjthQUMxQyxDQUFDO1NBQ0g7UUFFRCxPQUFPLFlBQVksQ0FBQztJQUN0QixDQUFDO0lBRU8sU0FBUztRQUNmLE9BQU8sSUFBSSxDQUFDLE9BQU8sSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLEtBQUssS0FBSyxDQUFDO0lBQ3BFLENBQUM7SUFFTyxZQUFZO1FBQ2xCLElBQUksSUFBSSxDQUFDLE9BQU8sWUFBWSxVQUFVLElBQUksSUFBSSxDQUFDLE9BQU8sWUFBWSxPQUFPLEVBQUU7WUFDekUsS0FBSyxNQUFNLEtBQUssSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEVBQUU7Z0JBQ3JELElBQUksS0FBSyxDQUFDLE9BQU8sS0FBSyxPQUFPLEVBQUU7b0JBQzdCLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztpQkFDaEI7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUVPLEtBQUssQ0FBQyxhQUFhO1FBQ3pCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQUUsT0FBTztRQUM5QixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsVUFBVSxFQUFHLENBQUM7UUFFbkMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7WUFDaEIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQ0FBMEMsQ0FBQyxDQUFDO1NBQzdEO1FBRUQseUJBQXlCO1FBQ3pCLElBQUksQ0FBQyxZQUFZLEVBQUUsQ0FBQztRQUVwQixJQUFJO1lBQ0YsSUFBSSxDQUFDLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7U0FDN0Y7UUFBQyxPQUFPLEdBQUcsRUFBRTtZQUNaLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLEVBQUU7Z0JBQ3ZCLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQVksQ0FBQyxDQUFDO2FBQ25DO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7YUFDcEI7WUFDRCxPQUFPO1NBQ1I7UUFFRCxNQUFNLGFBQWEsR0FBc0M7WUFDdkQsVUFBVSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsVUFBVTtZQUNsQyxXQUFXLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxXQUFXO1lBQ3BDLGNBQWMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLGNBQWM7WUFDMUMsWUFBWSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWTtZQUN0QyxPQUFPLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDekIscUJBQXFCLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxjQUFjLENBQUMscUJBQXFCO1NBQ3hFLENBQUM7UUFFRixNQUFNLFFBQVEsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDdkMsSUFBSSxRQUFRLFlBQVksVUFBVSxFQUFFO1lBQ2xDLGFBQWEsQ0FBQyxjQUFjLEdBQUcsUUFBUSxDQUFDO1NBQ3pDO1FBRUQsb0JBQW9CO1FBQ3BCLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXZELElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxFQUFFLENBQUMsT0FBTyxDQUFDLFNBQVMsRUFBRSxXQUFXLENBQUMsQ0FBQyxDQUFDO1FBQzdELE9BQU8sQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFNUIsSUFBSSxVQUFVLEdBQUcsS0FBSyxDQUFDO1FBQ3ZCLElBQUksVUFBZ0UsQ0FBQztRQUVyRSxJQUFJO1lBQ0YsVUFBVSxHQUFHLE1BQU0sSUFBSSxDQUFDLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLHlCQUF5QixDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO1lBQ3pGLFVBQVU7Z0JBQ1IsQ0FBQyxVQUFVLENBQUMsTUFBTSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyw2QkFBNkIsQ0FBQzt1QkFDOUQsQ0FBQyxVQUFVLENBQUMsTUFBTSxJQUFJLFVBQVUsQ0FBQyxvQkFBb0IsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLDZCQUE2QixDQUFDO3VCQUNuRyxLQUFLLENBQUM7U0FDWjtRQUFDLE9BQU8sR0FBRyxFQUFFO1lBQ1osSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sRUFBRTtnQkFDdkIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsR0FBWSxDQUFDLENBQUM7YUFDbkM7aUJBQU07Z0JBQ0wsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUNwQjtTQUNGO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFBRSxPQUFPO1FBRTlCLElBQUksVUFBVSxFQUFFO1lBQ2QsSUFBSTtnQkFDRixJQUFJLENBQUMsTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyw0QkFBNEIsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzthQUNqRjtZQUFDLE9BQU8sR0FBRyxFQUFFO2dCQUNaLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUUsR0FBRyxDQUFDLENBQUM7YUFDekM7WUFFRCwwQkFBMEI7WUFDMUIsSUFBSSxDQUFDLFlBQVksQ0FDZixPQUFPLEVBQ1AsQ0FBQyxPQUFPLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQyxTQUFTLElBQUksU0FBUyxLQUFLLFdBQVcsQ0FBQyxDQUNqRyxDQUFDO1NBQ0g7UUFFRCxJQUFJLElBQUksQ0FBQyxZQUFZLEtBQUssVUFBVSxFQUFFLE1BQU0sSUFBSSxJQUFJLENBQUMsb0JBQW9CLEtBQUssVUFBVSxFQUFFLG9CQUFvQixFQUFFO1lBQzlHLElBQUksQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUM7WUFDekMsSUFBSSxDQUFDLG9CQUFvQixHQUFHLFVBQVUsRUFBRSxvQkFBb0IsQ0FBQztZQUU3RCxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLEVBQUU7Z0JBQ2xDLE1BQU0sa0JBQWtCLEdBQTZCO29CQUNuRCxlQUFlLEVBQUUsVUFBVTtvQkFDM0IsWUFBWSxFQUFFLElBQUksQ0FBQyxZQUFZO2lCQUNoQyxDQUFDO2dCQUVGLElBQUksSUFBSSxDQUFDLG9CQUFvQixFQUFFO29CQUM3QixrQkFBa0IsQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLENBQUMsb0JBQW9CLENBQUM7aUJBQ3JFO2dCQUVELElBQUksQ0FBQyxNQUFNLENBQUMsa0JBQWtCLENBQUMsa0JBQWtCLENBQUMsQ0FBQzthQUNwRDtTQUNGO0lBQ0gsQ0FBQztJQTZDTyxZQUFZLENBQUMsT0FBZ0IsRUFBRSxVQUFvQjtRQUN6RCxNQUFNLFNBQVMsR0FBRyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQzVELElBQUksU0FBUyxFQUFFO1lBQ2IsT0FBTyxDQUFDLFNBQVMsR0FBRyxTQUFTLENBQUM7U0FDL0I7YUFBTTtZQUNMLE9BQU8sQ0FBQyxlQUFlLENBQUMsT0FBTyxDQUFDLENBQUM7U0FDbEM7SUFDSCxDQUFDO0lBRU8sWUFBWTtRQUNsQixJQUFJLE9BQU8sUUFBUSxLQUFLLFdBQVc7WUFBRSxPQUFPO1FBRTVDLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxPQUFPLEVBQUUsV0FBVyxFQUF1QyxDQUFDO1FBQ2xGLE1BQU0sT0FBTyxHQUFHLHdCQUF3QixJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUFFLEVBQUUsQ0FBQyxJQUN0RixJQUFJLENBQUMsTUFBTSxFQUFFLFlBQ2YsRUFBRSxDQUFDO1FBRUgsZ0RBQWdEO1FBQ2hELElBQUksUUFBUSxFQUFFO1lBQ1osSUFBSSxDQUFDLFFBQVEsQ0FBQyxjQUFjLEVBQUUsQ0FBQyxPQUFPLENBQUMsRUFBRTtnQkFDdkMsTUFBTSxLQUFLLEdBQUcsUUFBUSxDQUFDLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQztnQkFDOUMsS0FBSyxDQUFDLEVBQUUsR0FBRyxPQUFPLENBQUM7Z0JBQ25CLEtBQUssQ0FBQyxJQUFJLEdBQUcsVUFBVSxDQUFDO2dCQUN4QixLQUFLLENBQUMsU0FBUyxHQUFHO1lBQ2QsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXOzs7WUFHeEIsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXOzs7OztTQUszQixDQUFDO2dCQUVGLElBQUksUUFBUSxZQUFZLFFBQVEsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO29CQUNqRCxRQUFRLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDbEM7cUJBQU07b0JBQ0wsUUFBUSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDN0I7YUFDRjtTQUNGO0lBQ0gsQ0FBQztJQUVPLG1CQUFtQixDQUFDLFNBQWlCO1FBQzNDLElBQUksQ0FBQyxJQUFJLENBQUMscUJBQXFCO1lBQUUsT0FBTyxJQUFJLENBQUM7UUFFN0MsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLHFCQUFxQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3hELE9BQU8sU0FBUyxDQUFDLElBQUksQ0FDbkIsQ0FBQyxLQUFLLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLHFCQUFzQixDQUFDLEtBQUssQ0FBQyxDQUFDLENBQy9GLENBQUM7SUFDSixDQUFDO0lBRU8scUJBQXFCLENBQUMsTUFBYztRQUMxQyxPQUFPO1lBQ0wsTUFBTSxDQUFDLFdBQVc7WUFDbEIsTUFBTSxDQUFDLDZCQUE2QjtZQUNwQyxDQUFDLENBQUMsTUFBTSxDQUFDLG9CQUFvQjtZQUM3QixDQUFDLENBQUMsTUFBTSxDQUFDLG1CQUFtQjtZQUM1QixNQUFNLENBQUMsV0FBVztZQUNsQixNQUFNLENBQUMsVUFBVTtZQUNqQixNQUFNLENBQUMsWUFBWTtZQUNuQixNQUFNLENBQUMsY0FBYztZQUNyQixNQUFNLENBQUMsY0FBYyxDQUFDLFlBQVksQ0FBQyxVQUFVO1lBQzdDLE1BQU0sQ0FBQyxjQUFjLENBQUMsWUFBWSxDQUFDLFlBQVk7WUFDL0MsTUFBTSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDbkQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxZQUFZLENBQUMsWUFBWSxFQUFFLE9BQU87WUFDeEQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxxQkFBcUI7U0FDNUMsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IDIwMjAgR29vZ2xlIExMQ1xuICpcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBBcGFjaGUgTGljZW5zZSwgVmVyc2lvbiAyLjAgKHRoZSBcIkxpY2Vuc2VcIik7XG4gKiB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuXG4gKiBZb3UgbWF5IG9idGFpbiBhIGNvcHkgb2YgdGhlIExpY2Vuc2UgYXRcbiAqXG4gKiAgICAgIGh0dHA6Ly93d3cuYXBhY2hlLm9yZy9saWNlbnNlcy9MSUNFTlNFLTIuMFxuICpcbiAqIFVubGVzcyByZXF1aXJlZCBieSBhcHBsaWNhYmxlIGxhdyBvciBhZ3JlZWQgdG8gaW4gd3JpdGluZywgc29mdHdhcmVcbiAqIGRpc3RyaWJ1dGVkIHVuZGVyIHRoZSBMaWNlbnNlIGlzIGRpc3RyaWJ1dGVkIG9uIGFuIFwiQVMgSVNcIiBCQVNJUyxcbiAqIFdJVEhPVVQgV0FSUkFOVElFUyBPUiBDT05ESVRJT05TIE9GIEFOWSBLSU5ELCBlaXRoZXIgZXhwcmVzcyBvciBpbXBsaWVkLlxuICogU2VlIHRoZSBMaWNlbnNlIGZvciB0aGUgc3BlY2lmaWMgbGFuZ3VhZ2UgZ292ZXJuaW5nIHBlcm1pc3Npb25zIGFuZFxuICogbGltaXRhdGlvbnMgdW5kZXIgdGhlIExpY2Vuc2UuXG4gKi9cblxuLyogZXNsaW50LWRpc2FibGUgcmVhY3Qvbm8taXMtbW91bnRlZCAqL1xuXG5pbXBvcnQgeyBsb2FkU2NyaXB0IH0gZnJvbSAnLi4vbGliL2xvYWQtc2NyaXB0JztcblxuZXhwb3J0IGludGVyZmFjZSBSZWFkeVRvUGF5Q2hhbmdlUmVzcG9uc2Uge1xuICBpc0J1dHRvblZpc2libGU6IGJvb2xlYW47XG4gIGlzUmVhZHlUb1BheTogYm9vbGVhbjtcbiAgcGF5bWVudE1ldGhvZFByZXNlbnQ/OiBib29sZWFuO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIENvbmZpZyB7XG4gIGVudmlyb25tZW50OiBnb29nbGUucGF5bWVudHMuYXBpLkVudmlyb25tZW50O1xuICBleGlzdGluZ1BheW1lbnRNZXRob2RSZXF1aXJlZD86IGJvb2xlYW47XG4gIHBheW1lbnRSZXF1ZXN0OiBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnREYXRhUmVxdWVzdDtcbiAgb25QYXltZW50RGF0YUNoYW5nZWQ/OiBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnREYXRhQ2hhbmdlZEhhbmRsZXI7XG4gIG9uUGF5bWVudEF1dGhvcml6ZWQ/OiBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnRBdXRob3JpemVkSGFuZGxlcjtcbiAgb25Mb2FkUGF5bWVudERhdGE/OiAocGF5bWVudERhdGE6IGdvb2dsZS5wYXltZW50cy5hcGkuUGF5bWVudERhdGEpID0+IHZvaWQ7XG4gIG9uQ2FuY2VsPzogKHJlYXNvbjogZ29vZ2xlLnBheW1lbnRzLmFwaS5QYXltZW50c0Vycm9yKSA9PiB2b2lkO1xuICBvbkVycm9yPzogKGVycm9yOiBFcnJvciB8IGdvb2dsZS5wYXltZW50cy5hcGkuUGF5bWVudHNFcnJvcikgPT4gdm9pZDtcbiAgb25SZWFkeVRvUGF5Q2hhbmdlPzogKHJlc3VsdDogUmVhZHlUb1BheUNoYW5nZVJlc3BvbnNlKSA9PiB2b2lkO1xuICBvbkNsaWNrPzogKGV2ZW50OiBFdmVudCkgPT4gdm9pZDtcbiAgYnV0dG9uQ29sb3I/OiBnb29nbGUucGF5bWVudHMuYXBpLkJ1dHRvbkNvbG9yO1xuICBidXR0b25UeXBlPzogZ29vZ2xlLnBheW1lbnRzLmFwaS5CdXR0b25UeXBlO1xuICBidXR0b25TaXplTW9kZT86IGdvb2dsZS5wYXltZW50cy5hcGkuQnV0dG9uU2l6ZU1vZGU7XG4gIGJ1dHRvbkxvY2FsZT86IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEJ1dHRvbk1hbmFnZXJPcHRpb25zIHtcbiAgY3NzU2VsZWN0b3I6IHN0cmluZztcbiAgc29mdHdhcmVJbmZvSWQ6IHN0cmluZztcbiAgc29mdHdhcmVJbmZvVmVyc2lvbjogc3RyaW5nO1xufVxuXG4vKipcbiAqIE1hbmFnZXMgdGhlIGxpZmVjeWNsZSBvZiB0aGUgR29vZ2xlIFBheSBidXR0b24uXG4gKlxuICogSW5jbHVkZXMgbGlmZWN5Y2xlIG1hbmFnZW1lbnQgb2YgdGhlIGBQYXltZW50c0NsaWVudGAgaW5zdGFuY2UsXG4gKiBgaXNSZWFkeVRvUGF5YCwgYG9uQ2xpY2tgLCBgbG9hZFBheW1lbnREYXRhYCwgYW5kIG90aGVyIGNhbGxiYWNrIG1ldGhvZHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBCdXR0b25NYW5hZ2VyIHtcbiAgcHJpdmF0ZSBjbGllbnQ/OiBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnRzQ2xpZW50O1xuICBwcml2YXRlIGNvbmZpZz86IENvbmZpZztcbiAgcHJpdmF0ZSBlbGVtZW50PzogRWxlbWVudDtcbiAgcHJpdmF0ZSBvcHRpb25zOiBCdXR0b25NYW5hZ2VyT3B0aW9ucztcbiAgcHJpdmF0ZSBvbGRJbnZhbGlkYXRpb25WYWx1ZXM/OiBhbnlbXTtcblxuICBpc1JlYWR5VG9QYXk/OiBib29sZWFuO1xuICBwYXltZW50TWV0aG9kUHJlc2VudD86IGJvb2xlYW47XG5cbiAgY29uc3RydWN0b3Iob3B0aW9uczogQnV0dG9uTWFuYWdlck9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG5cbiAgZ2V0RWxlbWVudCgpOiBFbGVtZW50IHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gdGhpcy5lbGVtZW50O1xuICB9XG5cbiAgcHJpdmF0ZSBpc0dvb2dsZVBheUxvYWRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gJ2dvb2dsZScgaW4gKHdpbmRvdyB8fCBnbG9iYWwpICYmICEhZ29vZ2xlPy5wYXltZW50cz8uYXBpPy5QYXltZW50c0NsaWVudDtcbiAgfVxuXG4gIGFzeW5jIG1vdW50KGVsZW1lbnQ6IEVsZW1lbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuaXNHb29nbGVQYXlMb2FkZWQoKSkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgbG9hZFNjcmlwdCgnaHR0cHM6Ly9wYXkuZ29vZ2xlLmNvbS9ncC9wL2pzL3BheS5qcycpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZz8ub25FcnJvcikge1xuICAgICAgICAgIHRoaXMuY29uZmlnLm9uRXJyb3IoZXJyIGFzIEVycm9yKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7XG4gICAgaWYgKGVsZW1lbnQpIHtcbiAgICAgIHRoaXMuYXBwZW5kU3R5bGVzKCk7XG4gICAgICBpZiAodGhpcy5jb25maWcpIHtcbiAgICAgICAgdGhpcy51cGRhdGVFbGVtZW50KCk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgdW5tb3VudCgpOiB2b2lkIHtcbiAgICB0aGlzLmVsZW1lbnQgPSB1bmRlZmluZWQ7XG4gIH1cblxuICBjb25maWd1cmUobmV3Q29uZmlnOiBDb25maWcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBsZXQgcHJvbWlzZTogUHJvbWlzZTx2b2lkPiB8IHVuZGVmaW5lZCA9IHVuZGVmaW5lZDtcbiAgICB0aGlzLmNvbmZpZyA9IG5ld0NvbmZpZztcbiAgICBpZiAoIXRoaXMub2xkSW52YWxpZGF0aW9uVmFsdWVzIHx8IHRoaXMuaXNDbGllbnRJbnZhbGlkYXRlZChuZXdDb25maWcpKSB7XG4gICAgICBwcm9taXNlID0gdGhpcy51cGRhdGVFbGVtZW50KCk7XG4gICAgfVxuICAgIHRoaXMub2xkSW52YWxpZGF0aW9uVmFsdWVzID0gdGhpcy5nZXRJbnZhbGlkYXRpb25WYWx1ZXMobmV3Q29uZmlnKTtcblxuICAgIHJldHVybiBwcm9taXNlID8/IFByb21pc2UucmVzb2x2ZSgpO1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgY2xpZW50IGNvbmZpZ3VyYXRpb24gb3B0aW9ucyBiYXNlZCBvbiBidXR0b24gY29uZmlndXJhdGlvblxuICAgKiBvcHRpb25zLlxuICAgKlxuICAgKiBUaGlzIG1ldGhvZCB3b3VsZCBub3JtYWxseSBiZSBwcml2YXRlIGJ1dCBoYXMgYmVlbiBtYWRlIHB1YmxpYyBmb3JcbiAgICogdGVzdGluZyBwdXJwb3Nlcy5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGNyZWF0ZUNsaWVudE9wdGlvbnMoY29uZmlnOiBDb25maWcpOiBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnRPcHRpb25zIHtcbiAgICBjb25zdCBjbGllbnRDb25maWc6IGdvb2dsZS5wYXltZW50cy5hcGkuUGF5bWVudE9wdGlvbnMgPSB7XG4gICAgICBlbnZpcm9ubWVudDogY29uZmlnLmVudmlyb25tZW50LFxuICAgICAgbWVyY2hhbnRJbmZvOiB0aGlzLmNyZWF0ZU1lcmNoYW50SW5mbyhjb25maWcpLFxuICAgIH07XG5cbiAgICBpZiAoY29uZmlnLm9uUGF5bWVudERhdGFDaGFuZ2VkIHx8IGNvbmZpZy5vblBheW1lbnRBdXRob3JpemVkKSB7XG4gICAgICBjbGllbnRDb25maWcucGF5bWVudERhdGFDYWxsYmFja3MgPSB7fTtcblxuICAgICAgaWYgKGNvbmZpZy5vblBheW1lbnREYXRhQ2hhbmdlZCkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2V4cGxpY2l0LWZ1bmN0aW9uLXJldHVybi10eXBlXG4gICAgICAgIGNsaWVudENvbmZpZy5wYXltZW50RGF0YUNhbGxiYWNrcy5vblBheW1lbnREYXRhQ2hhbmdlZCA9IHBheW1lbnREYXRhID0+IHtcbiAgICAgICAgICBjb25zdCByZXN1bHQgPSBjb25maWcub25QYXltZW50RGF0YUNoYW5nZWQhKHBheW1lbnREYXRhKTtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0IHx8ICh7fSBhcyBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnREYXRhUmVxdWVzdFVwZGF0ZSk7XG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIGlmIChjb25maWcub25QYXltZW50QXV0aG9yaXplZCkge1xuICAgICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L2V4cGxpY2l0LWZ1bmN0aW9uLXJldHVybi10eXBlXG4gICAgICAgIGNsaWVudENvbmZpZy5wYXltZW50RGF0YUNhbGxiYWNrcy5vblBheW1lbnRBdXRob3JpemVkID0gcGF5bWVudERhdGEgPT4ge1xuICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNvbmZpZy5vblBheW1lbnRBdXRob3JpemVkIShwYXltZW50RGF0YSk7XG4gICAgICAgICAgcmV0dXJuIHJlc3VsdCB8fCAoe30gYXMgZ29vZ2xlLnBheW1lbnRzLmFwaS5QYXltZW50QXV0aG9yaXphdGlvblJlc3VsdCk7XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNsaWVudENvbmZpZztcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlSXNSZWFkeVRvUGF5UmVxdWVzdChjb25maWc6IENvbmZpZyk6IGdvb2dsZS5wYXltZW50cy5hcGkuSXNSZWFkeVRvUGF5UmVxdWVzdCB7XG4gICAgY29uc3QgcGF5bWVudFJlcXVlc3QgPSBjb25maWcucGF5bWVudFJlcXVlc3Q7XG4gICAgY29uc3QgcmVxdWVzdDogZ29vZ2xlLnBheW1lbnRzLmFwaS5Jc1JlYWR5VG9QYXlSZXF1ZXN0ID0ge1xuICAgICAgYXBpVmVyc2lvbjogcGF5bWVudFJlcXVlc3QuYXBpVmVyc2lvbixcbiAgICAgIGFwaVZlcnNpb25NaW5vcjogcGF5bWVudFJlcXVlc3QuYXBpVmVyc2lvbk1pbm9yLFxuICAgICAgYWxsb3dlZFBheW1lbnRNZXRob2RzOiBwYXltZW50UmVxdWVzdC5hbGxvd2VkUGF5bWVudE1ldGhvZHMsXG4gICAgICBleGlzdGluZ1BheW1lbnRNZXRob2RSZXF1aXJlZDogY29uZmlnLmV4aXN0aW5nUGF5bWVudE1ldGhvZFJlcXVpcmVkLFxuICAgIH07XG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25zdHJ1Y3RzIGBsb2FkUGF5bWVudERhdGFgIHJlcXVlc3Qgb2JqZWN0IGJhc2VkIG9uIGJ1dHRvbiBjb25maWd1cmF0aW9uLlxuICAgKlxuICAgKiBJdCBpbmZlcnMgcmVxdWVzdCBwcm9wZXJ0aWVzIGxpa2UgYHNoaXBwaW5nQWRkcmVzc1JlcXVpcmVkYCxcbiAgICogYHNoaXBwaW5nT3B0aW9uUmVxdWlyZWRgLCBhbmQgYGJpbGxpbmdBZGRyZXNzUmVxdWlyZWRgIGlmIG5vdCBhbHJlYWR5IHNldFxuICAgKiBiYXNlZCBvbiB0aGUgcHJlc2VuY2Ugb2YgdGhlaXIgYXNzb2NpYXRlZCBvcHRpb25zIGFuZCBwYXJhbWV0ZXJzLiBJdCBhbHNvXG4gICAqIGluZmVycyBgY2FsbGJhY2tJbnRlbnRzYCBiYXNlZCBvbiB0aGUgY2FsbGJhY2sgbWV0aG9kcyBkZWZpbmVkIGluIGJ1dHRvblxuICAgKiBjb25maWd1cmF0aW9uLlxuICAgKlxuICAgKiBUaGlzIG1ldGhvZCB3b3VsZCBub3JtYWxseSBiZSBwcml2YXRlIGJ1dCBoYXMgYmVlbiBtYWRlIHB1YmxpYyBmb3JcbiAgICogdGVzdGluZyBwdXJwb3Nlcy5cbiAgICpcbiAgICogQHByaXZhdGVcbiAgICovXG4gIGNyZWF0ZUxvYWRQYXltZW50RGF0YVJlcXVlc3QoY29uZmlnOiBDb25maWcpOiBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnREYXRhUmVxdWVzdCB7XG4gICAgY29uc3QgcmVxdWVzdCA9IHtcbiAgICAgIC4uLmNvbmZpZy5wYXltZW50UmVxdWVzdCxcbiAgICAgIG1lcmNoYW50SW5mbzogdGhpcy5jcmVhdGVNZXJjaGFudEluZm8oY29uZmlnKSxcbiAgICB9O1xuXG4gICAgLy8gVE9ETzogIzEzIHJlLWVuYWJsZSBpbmZlcnJlbmNlIGlmL3doZW4gd2UgYWdyZWUgYXMgYSB0ZWFtXG5cbiAgICByZXR1cm4gcmVxdWVzdDtcbiAgfVxuXG4gIHByaXZhdGUgY3JlYXRlTWVyY2hhbnRJbmZvKGNvbmZpZzogQ29uZmlnKTogZ29vZ2xlLnBheW1lbnRzLmFwaS5NZXJjaGFudEluZm8ge1xuICAgIGNvbnN0IG1lcmNoYW50SW5mbzogZ29vZ2xlLnBheW1lbnRzLmFwaS5NZXJjaGFudEluZm8gPSB7XG4gICAgICAuLi5jb25maWcucGF5bWVudFJlcXVlc3QubWVyY2hhbnRJbmZvLFxuICAgIH07XG5cbiAgICAvLyBhcHBseSBzb2Z0d2FyZUluZm8gaWYgbm90IHNldFxuICAgIGlmICghbWVyY2hhbnRJbmZvLnNvZnR3YXJlSW5mbykge1xuICAgICAgbWVyY2hhbnRJbmZvLnNvZnR3YXJlSW5mbyA9IHtcbiAgICAgICAgaWQ6IHRoaXMub3B0aW9ucy5zb2Z0d2FyZUluZm9JZCxcbiAgICAgICAgdmVyc2lvbjogdGhpcy5vcHRpb25zLnNvZnR3YXJlSW5mb1ZlcnNpb24sXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiBtZXJjaGFudEluZm87XG4gIH1cblxuICBwcml2YXRlIGlzTW91bnRlZCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5lbGVtZW50ICE9IG51bGwgJiYgdGhpcy5lbGVtZW50LmlzQ29ubmVjdGVkICE9PSBmYWxzZTtcbiAgfVxuXG4gIHByaXZhdGUgcmVtb3ZlQnV0dG9uKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmVsZW1lbnQgaW5zdGFuY2VvZiBTaGFkb3dSb290IHx8IHRoaXMuZWxlbWVudCBpbnN0YW5jZW9mIEVsZW1lbnQpIHtcbiAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgQXJyYXkuZnJvbSh0aGlzLmVsZW1lbnQuY2hpbGRyZW4pKSB7XG4gICAgICAgIGlmIChjaGlsZC50YWdOYW1lICE9PSAnU1RZTEUnKSB7XG4gICAgICAgICAgY2hpbGQucmVtb3ZlKCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHVwZGF0ZUVsZW1lbnQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmlzTW91bnRlZCgpKSByZXR1cm47XG4gICAgY29uc3QgZWxlbWVudCA9IHRoaXMuZ2V0RWxlbWVudCgpITtcblxuICAgIGlmICghdGhpcy5jb25maWcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZ29vZ2xlLXBheS1idXR0b246IE1pc3NpbmcgY29uZmlndXJhdGlvbicpO1xuICAgIH1cblxuICAgIC8vIHJlbW92ZSBleGlzdGluZyBidXR0b25cbiAgICB0aGlzLnJlbW92ZUJ1dHRvbigpO1xuXG4gICAgdHJ5IHtcbiAgICAgIHRoaXMuY2xpZW50ID0gbmV3IGdvb2dsZS5wYXltZW50cy5hcGkuUGF5bWVudHNDbGllbnQodGhpcy5jcmVhdGVDbGllbnRPcHRpb25zKHRoaXMuY29uZmlnKSk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAodGhpcy5jb25maWcub25FcnJvcikge1xuICAgICAgICB0aGlzLmNvbmZpZy5vbkVycm9yKGVyciBhcyBFcnJvcik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKGVycik7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3QgYnV0dG9uT3B0aW9uczogZ29vZ2xlLnBheW1lbnRzLmFwaS5CdXR0b25PcHRpb25zID0ge1xuICAgICAgYnV0dG9uVHlwZTogdGhpcy5jb25maWcuYnV0dG9uVHlwZSxcbiAgICAgIGJ1dHRvbkNvbG9yOiB0aGlzLmNvbmZpZy5idXR0b25Db2xvcixcbiAgICAgIGJ1dHRvblNpemVNb2RlOiB0aGlzLmNvbmZpZy5idXR0b25TaXplTW9kZSxcbiAgICAgIGJ1dHRvbkxvY2FsZTogdGhpcy5jb25maWcuYnV0dG9uTG9jYWxlLFxuICAgICAgb25DbGljazogdGhpcy5oYW5kbGVDbGljayxcbiAgICAgIGFsbG93ZWRQYXltZW50TWV0aG9kczogdGhpcy5jb25maWcucGF5bWVudFJlcXVlc3QuYWxsb3dlZFBheW1lbnRNZXRob2RzLFxuICAgIH07XG5cbiAgICBjb25zdCByb290Tm9kZSA9IGVsZW1lbnQuZ2V0Um9vdE5vZGUoKTtcbiAgICBpZiAocm9vdE5vZGUgaW5zdGFuY2VvZiBTaGFkb3dSb290KSB7XG4gICAgICBidXR0b25PcHRpb25zLmJ1dHRvblJvb3ROb2RlID0gcm9vdE5vZGU7XG4gICAgfVxuXG4gICAgLy8gcHJlLWNyZWF0ZSBidXR0b25cbiAgICBjb25zdCBidXR0b24gPSB0aGlzLmNsaWVudC5jcmVhdGVCdXR0b24oYnV0dG9uT3B0aW9ucyk7XG5cbiAgICB0aGlzLnNldENsYXNzTmFtZShlbGVtZW50LCBbZWxlbWVudC5jbGFzc05hbWUsICdub3QtcmVhZHknXSk7XG4gICAgZWxlbWVudC5hcHBlbmRDaGlsZChidXR0b24pO1xuXG4gICAgbGV0IHNob3dCdXR0b24gPSBmYWxzZTtcbiAgICBsZXQgcmVhZHlUb1BheTogZ29vZ2xlLnBheW1lbnRzLmFwaS5Jc1JlYWR5VG9QYXlSZXNwb25zZSB8IHVuZGVmaW5lZDtcblxuICAgIHRyeSB7XG4gICAgICByZWFkeVRvUGF5ID0gYXdhaXQgdGhpcy5jbGllbnQuaXNSZWFkeVRvUGF5KHRoaXMuY3JlYXRlSXNSZWFkeVRvUGF5UmVxdWVzdCh0aGlzLmNvbmZpZykpO1xuICAgICAgc2hvd0J1dHRvbiA9XG4gICAgICAgIChyZWFkeVRvUGF5LnJlc3VsdCAmJiAhdGhpcy5jb25maWcuZXhpc3RpbmdQYXltZW50TWV0aG9kUmVxdWlyZWQpXG4gICAgICAgIHx8IChyZWFkeVRvUGF5LnJlc3VsdCAmJiByZWFkeVRvUGF5LnBheW1lbnRNZXRob2RQcmVzZW50ICYmIHRoaXMuY29uZmlnLmV4aXN0aW5nUGF5bWVudE1ldGhvZFJlcXVpcmVkKVxuICAgICAgICB8fCBmYWxzZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICh0aGlzLmNvbmZpZy5vbkVycm9yKSB7XG4gICAgICAgIHRoaXMuY29uZmlnLm9uRXJyb3IoZXJyIGFzIEVycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuaXNNb3VudGVkKCkpIHJldHVybjtcblxuICAgIGlmIChzaG93QnV0dG9uKSB7XG4gICAgICB0cnkge1xuICAgICAgICB0aGlzLmNsaWVudC5wcmVmZXRjaFBheW1lbnREYXRhKHRoaXMuY3JlYXRlTG9hZFBheW1lbnREYXRhUmVxdWVzdCh0aGlzLmNvbmZpZykpO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKCdFcnJvciB3aXRoIHByZWZldGNoJywgZXJyKTtcbiAgICAgIH1cblxuICAgICAgLy8gcmVtb3ZlIGhpZGRlbiBjbGFzc05hbWVcbiAgICAgIHRoaXMuc2V0Q2xhc3NOYW1lKFxuICAgICAgICBlbGVtZW50LFxuICAgICAgICAoZWxlbWVudC5jbGFzc05hbWUgfHwgJycpLnNwbGl0KCcgJykuZmlsdGVyKGNsYXNzTmFtZSA9PiBjbGFzc05hbWUgJiYgY2xhc3NOYW1lICE9PSAnbm90LXJlYWR5JyksXG4gICAgICApO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmlzUmVhZHlUb1BheSAhPT0gcmVhZHlUb1BheT8ucmVzdWx0IHx8IHRoaXMucGF5bWVudE1ldGhvZFByZXNlbnQgIT09IHJlYWR5VG9QYXk/LnBheW1lbnRNZXRob2RQcmVzZW50KSB7XG4gICAgICB0aGlzLmlzUmVhZHlUb1BheSA9ICEhcmVhZHlUb1BheT8ucmVzdWx0O1xuICAgICAgdGhpcy5wYXltZW50TWV0aG9kUHJlc2VudCA9IHJlYWR5VG9QYXk/LnBheW1lbnRNZXRob2RQcmVzZW50O1xuXG4gICAgICBpZiAodGhpcy5jb25maWcub25SZWFkeVRvUGF5Q2hhbmdlKSB7XG4gICAgICAgIGNvbnN0IHJlYWR5VG9QYXlSZXNwb25zZTogUmVhZHlUb1BheUNoYW5nZVJlc3BvbnNlID0ge1xuICAgICAgICAgIGlzQnV0dG9uVmlzaWJsZTogc2hvd0J1dHRvbixcbiAgICAgICAgICBpc1JlYWR5VG9QYXk6IHRoaXMuaXNSZWFkeVRvUGF5LFxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICh0aGlzLnBheW1lbnRNZXRob2RQcmVzZW50KSB7XG4gICAgICAgICAgcmVhZHlUb1BheVJlc3BvbnNlLnBheW1lbnRNZXRob2RQcmVzZW50ID0gdGhpcy5wYXltZW50TWV0aG9kUHJlc2VudDtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuY29uZmlnLm9uUmVhZHlUb1BheUNoYW5nZShyZWFkeVRvUGF5UmVzcG9uc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGVzIHRoZSBjbGljayBldmVudCBvZiB0aGUgR29vZ2xlIFBheSBidXR0b24uXG4gICAqXG4gICAqIFRoaXMgbWV0aG9kIHdvdWxkIG5vcm1hbGx5IGJlIHByaXZhdGUgYnV0IGhhcyBiZWVuIG1hZGUgcHVibGljIGZvclxuICAgKiB0ZXN0aW5nIHB1cnBvc2VzLlxuICAgKlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgaGFuZGxlQ2xpY2sgPSBhc3luYyAoZXZlbnQ6IEV2ZW50KTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgY29uc3QgY29uZmlnID0gdGhpcy5jb25maWc7XG4gICAgaWYgKCFjb25maWcpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignZ29vZ2xlLXBheS1idXR0b246IE1pc3NpbmcgY29uZmlndXJhdGlvbicpO1xuICAgIH1cblxuICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLmNyZWF0ZUxvYWRQYXltZW50RGF0YVJlcXVlc3QoY29uZmlnKTtcblxuICAgIHRyeSB7XG4gICAgICBpZiAoY29uZmlnLm9uQ2xpY2spIHtcbiAgICAgICAgY29uZmlnLm9uQ2xpY2soZXZlbnQpO1xuICAgICAgfVxuXG4gICAgICBpZiAoZXZlbnQuZGVmYXVsdFByZXZlbnRlZCkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2xpZW50IS5sb2FkUGF5bWVudERhdGEocmVxdWVzdCk7XG5cbiAgICAgIGlmIChjb25maWcub25Mb2FkUGF5bWVudERhdGEpIHtcbiAgICAgICAgY29uZmlnLm9uTG9hZFBheW1lbnREYXRhKHJlc3VsdCk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBpZiAoKGVyciBhcyBnb29nbGUucGF5bWVudHMuYXBpLlBheW1lbnRzRXJyb3IpLnN0YXR1c0NvZGUgPT09ICdDQU5DRUxFRCcpIHtcbiAgICAgICAgaWYgKGNvbmZpZy5vbkNhbmNlbCkge1xuICAgICAgICAgIGNvbmZpZy5vbkNhbmNlbChlcnIgYXMgZ29vZ2xlLnBheW1lbnRzLmFwaS5QYXltZW50c0Vycm9yKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChjb25maWcub25FcnJvcikge1xuICAgICAgICBjb25maWcub25FcnJvcihlcnIgYXMgZ29vZ2xlLnBheW1lbnRzLmFwaS5QYXltZW50c0Vycm9yKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG5cbiAgcHJpdmF0ZSBzZXRDbGFzc05hbWUoZWxlbWVudDogRWxlbWVudCwgY2xhc3NOYW1lczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICBjb25zdCBjbGFzc05hbWUgPSBjbGFzc05hbWVzLmZpbHRlcihuYW1lID0+IG5hbWUpLmpvaW4oJyAnKTtcbiAgICBpZiAoY2xhc3NOYW1lKSB7XG4gICAgICBlbGVtZW50LmNsYXNzTmFtZSA9IGNsYXNzTmFtZTtcbiAgICB9IGVsc2Uge1xuICAgICAgZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUoJ2NsYXNzJyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhcHBlbmRTdHlsZXMoKTogdm9pZCB7XG4gICAgaWYgKHR5cGVvZiBkb2N1bWVudCA9PT0gJ3VuZGVmaW5lZCcpIHJldHVybjtcblxuICAgIGNvbnN0IHJvb3ROb2RlID0gdGhpcy5lbGVtZW50Py5nZXRSb290Tm9kZSgpIGFzIERvY3VtZW50IHwgU2hhZG93Um9vdCB8IHVuZGVmaW5lZDtcbiAgICBjb25zdCBzdHlsZUlkID0gYGRlZmF1bHQtZ29vZ2xlLXN0eWxlLSR7dGhpcy5vcHRpb25zLmNzc1NlbGVjdG9yLnJlcGxhY2UoL1teXFx3LV0rL2csICcnKX0tJHtcbiAgICAgIHRoaXMuY29uZmlnPy5idXR0b25Mb2NhbGVcbiAgICB9YDtcblxuICAgIC8vIGluaXRpYWxpemUgc3R5bGVzIGlmIHJlbmRlcmluZyBvbiB0aGUgY2xpZW50OlxuICAgIGlmIChyb290Tm9kZSkge1xuICAgICAgaWYgKCFyb290Tm9kZS5nZXRFbGVtZW50QnlJZD8uKHN0eWxlSWQpKSB7XG4gICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTtcbiAgICAgICAgc3R5bGUuaWQgPSBzdHlsZUlkO1xuICAgICAgICBzdHlsZS50eXBlID0gJ3RleHQvY3NzJztcbiAgICAgICAgc3R5bGUuaW5uZXJIVE1MID0gYFxuICAgICAgICAgICR7dGhpcy5vcHRpb25zLmNzc1NlbGVjdG9yfSB7XG4gICAgICAgICAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7XG4gICAgICAgICAgfVxuICAgICAgICAgICR7dGhpcy5vcHRpb25zLmNzc1NlbGVjdG9yfS5ub3QtcmVhZHkge1xuICAgICAgICAgICAgd2lkdGg6IDA7XG4gICAgICAgICAgICBoZWlnaHQ6IDA7XG4gICAgICAgICAgICBvdmVyZmxvdzogaGlkZGVuO1xuICAgICAgICAgIH1cbiAgICAgICAgYDtcblxuICAgICAgICBpZiAocm9vdE5vZGUgaW5zdGFuY2VvZiBEb2N1bWVudCAmJiByb290Tm9kZS5oZWFkKSB7XG4gICAgICAgICAgcm9vdE5vZGUuaGVhZC5hcHBlbmRDaGlsZChzdHlsZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgcm9vdE5vZGUuYXBwZW5kQ2hpbGQoc3R5bGUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBpc0NsaWVudEludmFsaWRhdGVkKG5ld0NvbmZpZzogQ29uZmlnKTogYm9vbGVhbiB7XG4gICAgaWYgKCF0aGlzLm9sZEludmFsaWRhdGlvblZhbHVlcykgcmV0dXJuIHRydWU7XG5cbiAgICBjb25zdCBuZXdWYWx1ZXMgPSB0aGlzLmdldEludmFsaWRhdGlvblZhbHVlcyhuZXdDb25maWcpO1xuICAgIHJldHVybiBuZXdWYWx1ZXMuc29tZShcbiAgICAgICh2YWx1ZSwgaW5kZXgpID0+IEpTT04uc3RyaW5naWZ5KHZhbHVlKSAhPT0gSlNPTi5zdHJpbmdpZnkodGhpcy5vbGRJbnZhbGlkYXRpb25WYWx1ZXMhW2luZGV4XSksXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0SW52YWxpZGF0aW9uVmFsdWVzKGNvbmZpZzogQ29uZmlnKTogYW55W10ge1xuICAgIHJldHVybiBbXG4gICAgICBjb25maWcuZW52aXJvbm1lbnQsXG4gICAgICBjb25maWcuZXhpc3RpbmdQYXltZW50TWV0aG9kUmVxdWlyZWQsXG4gICAgICAhIWNvbmZpZy5vblBheW1lbnREYXRhQ2hhbmdlZCxcbiAgICAgICEhY29uZmlnLm9uUGF5bWVudEF1dGhvcml6ZWQsXG4gICAgICBjb25maWcuYnV0dG9uQ29sb3IsXG4gICAgICBjb25maWcuYnV0dG9uVHlwZSxcbiAgICAgIGNvbmZpZy5idXR0b25Mb2NhbGUsXG4gICAgICBjb25maWcuYnV0dG9uU2l6ZU1vZGUsXG4gICAgICBjb25maWcucGF5bWVudFJlcXVlc3QubWVyY2hhbnRJbmZvLm1lcmNoYW50SWQsXG4gICAgICBjb25maWcucGF5bWVudFJlcXVlc3QubWVyY2hhbnRJbmZvLm1lcmNoYW50TmFtZSxcbiAgICAgIGNvbmZpZy5wYXltZW50UmVxdWVzdC5tZXJjaGFudEluZm8uc29mdHdhcmVJbmZvPy5pZCxcbiAgICAgIGNvbmZpZy5wYXltZW50UmVxdWVzdC5tZXJjaGFudEluZm8uc29mdHdhcmVJbmZvPy52ZXJzaW9uLFxuICAgICAgY29uZmlnLnBheW1lbnRSZXF1ZXN0LmFsbG93ZWRQYXltZW50TWV0aG9kcyxcbiAgICBdO1xuICB9XG59XG4iXX0=